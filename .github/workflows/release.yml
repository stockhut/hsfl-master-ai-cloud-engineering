on:
  push:
    branches:
      - 'versioning-test' # TODO: change this to main
      - 'versioning' # TODO: change this to main
  workflow_dispatch:

jobs:
  bump-version:
    name: Create new release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }} # TODO: remove when testing is done

      - uses: cocogitto/cocogitto-action@1f7463bd27d1c999663b1d247791cb43c758c29a
        id: release
        with:
          check: false
          release: true
          git-user: 'Cog Bot'
          git-user-email: 'cog@example.org'

      - run: git log
       #The version number is accessible as a github action output
      - name: Print version
        run: "echo '${{ steps.release.outputs.version }}'"
      - run: git push
      - run: git push --tags
  build-recipe:
    name: Build recipe if necessary
    runs-on: ubuntu-latest
    needs:
      - bump-version
    steps:
      - run: git tag --points-at HEAD | grep "recipe-"
      - uses: ./.github/workflows/recipe-build-push-image.yml
  build-auth:
    name: Build auth if necessary
    runs-on: ubuntu-latest
    needs:
      - bump-version
    steps:
      - run: git tag --points-at HEAD | grep "auth-"
      - uses: ./.github/workflows/auth-build-push-image.yml